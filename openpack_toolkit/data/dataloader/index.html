<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>openpack_toolkit.data.dataloader API documentation</title>
<meta name="description" content="``dataloader`` provide utility function to load files saved in OpenPack dataset format." />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>openpack_toolkit.data.dataloader</code></h1>
</header>
<section id="section-intro">
<p><code>dataloader</code> provide utility function to load files saved in OpenPack dataset format.</p>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">&#34;&#34;&#34;``dataloader`` provide utility function to load files saved in OpenPack dataset format.
&#34;&#34;&#34;

from .annotation import load_and_resample_annotation, load_and_resample_operation_labels
from .imu import load_imu
from .keypoint import load_keypoints
from .iot import load_and_resample_scan_log

__all__ = [
    &#34;load_and_resample_annotation&#34;,
    &#34;load_and_resample_operation_labels&#34;,
    &#34;load_and_resample_scan_log&#34;,
    &#34;load_imu&#34;,
    &#34;load_keypoints&#34;,
]</code></pre>
</details>
</section>
<section>
<h2 class="section-title" id="header-submodules">Sub-modules</h2>
<dl>
<dt><code class="name"><a title="openpack_toolkit.data.dataloader.annotation" href="annotation.html">openpack_toolkit.data.dataloader.annotation</a></code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt><code class="name"><a title="openpack_toolkit.data.dataloader.imu" href="imu.html">openpack_toolkit.data.dataloader.imu</a></code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt><code class="name"><a title="openpack_toolkit.data.dataloader.iot" href="iot.html">openpack_toolkit.data.dataloader.iot</a></code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt><code class="name"><a title="openpack_toolkit.data.dataloader.keypoint" href="keypoint.html">openpack_toolkit.data.dataloader.keypoint</a></code></dt>
<dd>
<div class="desc"></div>
</dd>
</dl>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="openpack_toolkit.data.dataloader.load_and_resample_annotation"><code class="name flex">
<span>def <span class="ident">load_and_resample_annotation</span></span>(<span>path: pathlib.Path, unixtimes_ms: numpy.ndarray, classes: <a title="openpack_toolkit.activity.ActSet" href="../../activity/index.html#openpack_toolkit.activity.ActSet">ActSet</a>, label_col: str = 'id') ‑> pandas.core.frame.DataFrame</span>
</code></dt>
<dd>
<div class="desc"><p>Load annotation data and resample them according to unixtime sequence <code>T</code>.
If there are no annotation records for the given timestamp, that records is treated
as NULL class.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>path</code></strong> :&ensp;<code>Path</code></dt>
<dd>path to annotation CSV file.</dd>
<dt><strong><code>unixitmes</code></strong> :&ensp;<code>np.ndarray</code></dt>
<dd>unixtime seqeuence (milli-scond precision).</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>pd.DataFrame</code></dt>
<dd>-</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def load_and_resample_annotation(
    path: Path,
    unixtimes_ms: np.ndarray,
    classes: ActSet,
    label_col: str = &#34;id&#34;,
) -&gt; pd.DataFrame:
    &#34;&#34;&#34;Load annotation data and resample them according to unixtime sequence ``T``.
    If there are no annotation records for the given timestamp, that records is treated
    as NULL class.

    Args:
        path (Path): path to annotation CSV file.
        unixitmes (np.ndarray): unixtime seqeuence (milli-scond precision).
    Returns:
        pd.DataFrame: -
    &#34;&#34;&#34;
    null_class_id = classes.get_ignore_class_id()
    if isinstance(null_class_id, tuple):
        null_class_id = null_class_id[-1]

    df = pd.read_csv(path)
    logger.debug(f&#34;load annotation data from {path} -&gt; df={df.shape}&#34;)
    ut_min, ut_max = df[&#34;unixtime&#34;].min(), df[&#34;unixtime&#34;].max()

    null_record = df.head(1).copy()
    null_record[&#34;unixtime&#34;] = 0
    null_record[&#34;box&#34;] = 0
    null_record[label_col] = null_class_id
    df = pd.concat([df, null_record], axis=0, ignore_index=True)

    # unixtime with second precision.
    unixtimes_sec = unixtimes_ms - (unixtimes_ms % 1000)
    # Assing 0 to non-annotated sequence.
    unixtimes_sec[unixtimes_sec &lt; ut_min] = 0
    unixtimes_sec[unixtimes_sec &gt; ut_max] = 0

    df = df.rename(columns={&#34;unixtime&#34;: &#34;annot_time&#34;}).set_index(&#34;annot_time&#34;)
    df = df.loc[unixtimes_sec, :].reset_index(drop=False)
    df[&#34;unixtime&#34;] = unixtimes_ms

    df[&#34;act_id&#34;] = df[label_col]
    df[&#34;act_idx&#34;] = classes.convert_id_to_index(df[&#34;act_id&#34;].values)

    cols = [&#34;unixtime&#34;, &#34;annot_time&#34;, &#34;user&#34;, &#34;session&#34;, &#34;box&#34;, &#34;act_id&#34;, &#34;act_idx&#34;]
    return df[cols]</code></pre>
</details>
</dd>
<dt id="openpack_toolkit.data.dataloader.load_and_resample_operation_labels"><code class="name flex">
<span>def <span class="ident">load_and_resample_operation_labels</span></span>(<span>path: pathlib.Path, unixtimes_ms: numpy.ndarray, classes: <a title="openpack_toolkit.activity.ActSet" href="../../activity/index.html#openpack_toolkit.activity.ActSet">ActSet</a>) ‑> pandas.core.frame.DataFrame</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def load_and_resample_operation_labels(
    path: Path,
    unixtimes_ms: np.ndarray,
    classes: ActSet,
) -&gt; pd.DataFrame:
    return load_and_resample_annotation(path, unixtimes_ms, classes, label_col=&#34;id&#34;)</code></pre>
</details>
</dd>
<dt id="openpack_toolkit.data.dataloader.load_and_resample_scan_log"><code class="name flex">
<span>def <span class="ident">load_and_resample_scan_log</span></span>(<span>path: pathlib.Path, unixtimes_ms: numpy.ndarray) ‑> numpy.ndarray</span>
</code></dt>
<dd>
<div class="desc"><p>Load scan log data such as HT, and make binary vector for given timestamps.
Elements that have the same timestamp in second precision are marked as 1.
Other values are set to 0.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>path</code></strong> :&ensp;<code>Path</code></dt>
<dd>path to a scan log CSV file.</dd>
<dt><strong><code>unixtimes_ms</code></strong> :&ensp;<code>np.ndarray</code></dt>
<dd>unixtime seqeuence (milli-scond precision).
shape=(T,).</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>np.ndarray</code></dt>
<dd>binary 1d vector.</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def load_and_resample_scan_log(
    path: Path,
    unixtimes_ms: np.ndarray,
) -&gt; np.ndarray:
    &#34;&#34;&#34;Load scan log data such as HT, and make binary vector for given timestamps.
    Elements that have the same timestamp in second precision are marked as 1.
    Other values are set to 0.

    Args:
        path (Path): path to a scan log CSV file.
        unixtimes_ms (np.ndarray):  unixtime seqeuence (milli-scond precision).
            shape=(T,).

    Returns:
        np.ndarray: binary 1d vector.
    &#34;&#34;&#34;
    assert unixtimes_ms.ndim == 1
    df = pd.read_csv(path)
    logger.info(f&#34;load scan log from {path} -&gt; df={df.shape}&#34;)

    unixtimes_sec = unixtimes_ms // 1000

    X_log = np.zeros(len(unixtimes_ms)).astype(np.int32)
    for utime_ms in df[&#34;unixtime&#34;].values:
        utime_sec = utime_ms // 1000
        ind = np.where(unixtimes_sec == utime_sec)[0]
        X_log[ind] = 1

    return X_log</code></pre>
</details>
</dd>
<dt id="openpack_toolkit.data.dataloader.load_imu"><code class="name flex">
<span>def <span class="ident">load_imu</span></span>(<span>paths: Union[Tuple[pathlib.Path, ...], List[pathlib.Path]], use_acc: bool = True, use_gyro: bool = False, use_quat: bool = False, th: int = 30) ‑> Tuple[numpy.ndarray, numpy.ndarray]</span>
</code></dt>
<dd>
<div class="desc"><p>Load IMU data from CSVs.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>paths</code></strong> :&ensp;<code>Union[Tuple[Path, &hellip;], List[Path]]</code></dt>
<dd>list of paths to target CSV.
(e.g., [**/atr01/S0100.csv])</dd>
<dt><strong><code>use_acc</code></strong> :&ensp;<code>bool</code>, optional</dt>
<dd>include acceleration signal (e.g., <code>acc_x, acc_y, acc_z</code>).
Defaults to True.</dd>
<dt><strong><code>use_gyro</code></strong> :&ensp;<code>bool</code>, optional</dt>
<dd>include gyro scope signal (e.g., <code>gyro_x, gyro_y, gyro_z</code>).
Defaults to False.</dd>
<dt><strong><code>use_quat</code></strong> :&ensp;<code>bool</code>, optional</dt>
<dd>include quaternion data(e.g.,
<code>quat_w, quat_x, quat_y, quat_z</code>). Defaults to False.</dd>
<dt><strong><code>th</code></strong> :&ensp;<code>int</code>, optional</dt>
<dd>threshold of timestamp difference [ms].
Default. 30 [ms] (&lt;= 1 sample)</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>Tuple[np.ndarray, np.ndarray]</code></dt>
<dd>unixtime and loaded sensor data.</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def load_imu(
    paths: Union[Tuple[Path, ...], List[Path]],
    use_acc: bool = True,
    use_gyro: bool = False,
    use_quat: bool = False,
    th: int = 30,
) -&gt; Tuple[np.ndarray, np.ndarray]:
    &#34;&#34;&#34;Load IMU data from CSVs.

    Args:
        paths (Union[Tuple[Path, ...], List[Path]]): list of paths to target CSV.
            (e.g., [**/atr01/S0100.csv])
        use_acc (bool, optional): include acceleration signal (e.g., ``acc_x, acc_y, acc_z``).
            Defaults to True.
        use_gyro (bool, optional): include gyro scope signal (e.g., ``gyro_x, gyro_y, gyro_z``).
            Defaults to False.
        use_quat (bool, optional): include quaternion data(e.g.,
            ``quat_w, quat_x, quat_y, quat_z``). Defaults to False.
        th (int, optional): threshold of timestamp difference [ms].
            Default. 30 [ms] (&lt;= 1 sample)
    Returns:
        Tuple[np.ndarray, np.ndarray]: unixtime and loaded sensor data.
    &#34;&#34;&#34;
    assert isinstance(
        paths, (tuple, list)
    ), f&#34;the first argument `paths` expects tuple of Path, not {type(paths)}.&#34;

    channels = []
    if use_acc:
        channels += [&#34;acc_x&#34;, &#34;acc_y&#34;, &#34;acc_z&#34;]
    if use_gyro:
        channels += [&#34;gyro_x&#34;, &#34;gyro_y&#34;, &#34;gyro_z&#34;]
    if use_quat:
        channels += [&#34;quat_w&#34;, &#34;quat_x&#34;, &#34;quat_y&#34;, &#34;quat_z&#34;]

    ts_ret, x_ret, ts_list = None, [], []
    for path in paths:
        df = pd.read_csv(path)
        logger.debug(f&#34;load IMU data from {path} -&gt; df={df.shape}&#34;)
        assert set(channels) &lt; set(df.columns)

        # NOTE: Error handling : ATR01 in U0101-S0500 has timestamp error.
        #       See an issue #87.
        if str(path).endswith(&#34;/U0101/atr/atr01/S0500.csv&#34;):
            df = df.drop(0, axis=0)
            df = df.reset_index(drop=True)

        ts = df[&#34;unixtime&#34;].values
        x = df[channels].values.T

        ts_list.append(ts)
        x_ret.append(x)

    min_len = min([len(ts) for ts in ts_list])
    ts_ret = None
    for i in range(len(paths)):
        x_ret[i] = x_ret[i][:, :min_len]
        ts_list[i] = ts_list[i][:min_len]

        if ts_ret is None:
            ts_ret = ts_list[i]
        else:
            # Check whether the timestamps are equal or not.
            delta = np.abs(ts_list[i] - ts_ret)
            assert delta.max() &lt; th, (
                f&#34;max difference is {delta.max()} [ms], &#34;
                f&#34;but difference smaller than th={th} is allowed.&#34;
            )

    x_ret = np.concatenate(x_ret, axis=0)
    return ts_ret, x_ret</code></pre>
</details>
</dd>
<dt id="openpack_toolkit.data.dataloader.load_keypoints"><code class="name flex">
<span>def <span class="ident">load_keypoints</span></span>(<span>path: pathlib.Path) ‑> Tuple[numpy.ndarray, numpy.ndarray]</span>
</code></dt>
<dd>
<div class="desc"><p>Load keypoints from JSON.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>path</code></strong> :&ensp;<code>Path</code></dt>
<dd>path to a target JSON file.</dd>
</dl>
<h2 id="returns">Returns</h2>
<p>Tuple[np.ndarray, np.ndarray]:
* T (np.ndarray): unixtime for each frame.
* X (np.ndarray): xy-cordinates of keypoints. and the score of corresponding
prediction. shape=(3, FRAMES, NODE). The first dim is corresponding to
[x-cordinate, y-cordinate, score].</p>
<h2 id="todo">Todo</h2>
<ul>
<li>Handle the JSON file that contains keypoints from multiple people.</li>
</ul></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def load_keypoints(path: Path) -&gt; Tuple[np.ndarray, np.ndarray]:
    &#34;&#34;&#34;Load keypoints from JSON.

    Args:
        path (Path): path to a target JSON file.
    Returns:
        Tuple[np.ndarray, np.ndarray]:
            * T (np.ndarray): unixtime for each frame.
            * X (np.ndarray): xy-cordinates of keypoints. and the score of corresponding
                prediction. shape=(3, FRAMES, NODE). The first dim is corresponding to
                [x-cordinate, y-cordinate, score].
    Todo:
        * Handle the JSON file that contains keypoints from multiple people.
    &#34;&#34;&#34;
    with open(path, &#34;r&#34;) as f:
        data = json.load(f)
    logger.debug(f&#34;load keypoints from {path}&#34;)

    T, X = [], []
    for i, d in enumerate(data[&#34;annotations&#34;][:]):
        ut = d.get(&#34;image_id&#34;, -1)
        kp = np.array(d.get(&#34;keypoints&#34;, []))

        X.append(kp.T)
        T.append(ut)

    T = np.array(T)
    X = np.stack(X, axis=1)

    return T, X</code></pre>
</details>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="openpack_toolkit.data" href="../index.html">openpack_toolkit.data</a></code></li>
</ul>
</li>
<li><h3><a href="#header-submodules">Sub-modules</a></h3>
<ul>
<li><code><a title="openpack_toolkit.data.dataloader.annotation" href="annotation.html">openpack_toolkit.data.dataloader.annotation</a></code></li>
<li><code><a title="openpack_toolkit.data.dataloader.imu" href="imu.html">openpack_toolkit.data.dataloader.imu</a></code></li>
<li><code><a title="openpack_toolkit.data.dataloader.iot" href="iot.html">openpack_toolkit.data.dataloader.iot</a></code></li>
<li><code><a title="openpack_toolkit.data.dataloader.keypoint" href="keypoint.html">openpack_toolkit.data.dataloader.keypoint</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="openpack_toolkit.data.dataloader.load_and_resample_annotation" href="#openpack_toolkit.data.dataloader.load_and_resample_annotation">load_and_resample_annotation</a></code></li>
<li><code><a title="openpack_toolkit.data.dataloader.load_and_resample_operation_labels" href="#openpack_toolkit.data.dataloader.load_and_resample_operation_labels">load_and_resample_operation_labels</a></code></li>
<li><code><a title="openpack_toolkit.data.dataloader.load_and_resample_scan_log" href="#openpack_toolkit.data.dataloader.load_and_resample_scan_log">load_and_resample_scan_log</a></code></li>
<li><code><a title="openpack_toolkit.data.dataloader.load_imu" href="#openpack_toolkit.data.dataloader.load_imu">load_imu</a></code></li>
<li><code><a title="openpack_toolkit.data.dataloader.load_keypoints" href="#openpack_toolkit.data.dataloader.load_keypoints">load_keypoints</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>